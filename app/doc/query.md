-- ✅ 1. Supabase SQL: DB 구조 변경 및 중복 방지
-- (1) votes 테이블에 category_id 추가 및 유저당 카테고리 1개 제한
-- (2) 기존 테이블 제거 후 재생성 (주의: 데이터 초기화됨)

-- DROP TABLES (주의: 순서 중요)
drop table if exists votes;
drop table if exists items;
drop table if exists categories;
drop table if exists groups;

-- GROUPS
create table public.groups (
id uuid primary key default uuid_generate_v4(),
name text not null,
created_at timestamp with time zone default now()
);

-- CATEGORIES
create table public.categories (
id uuid primary key default uuid_generate_v4(),
name text not null,
group_id uuid references public.groups(id) on delete cascade,
created_at timestamp with time zone default now()
);

-- ITEMS
create table public.items (
id bigint generated by default as identity primary key,
name text not null,
category_id uuid references public.categories(id) on delete cascade,
votes integer default 0,
created_at timestamp with time zone default now()
);

-- VOTES (✅ category_id 추가 + user_id + category_id 유니크)
create table public.votes (
id uuid primary key default uuid_generate_v4(),
user_id uuid references public.users(id) on delete cascade,
item_id bigint references public.items(id) on delete cascade,
category_id uuid references public.categories(id) on delete cascade,
created_at timestamp with time zone default now(),
unique (user_id, category_id) -- 한 카테고리당 하나만 추천 가능
);

create table public.users (
id uuid primary key default uuid_generate_v4(),
email text unique not null,
name text,
profile_image text,
created_at timestamp with time zone default now(),
tier text default 'free' -- 예: free, premium, admin 등
);

-- ✅ 2. Supabase RPC 변경 (votes 증가)
create or replace function public.increment_votes(item_id_input bigint)
returns void as $$
begin
update public.items set votes = votes + 1 where id = item_id_input;
end;

$$
language plpgsql;

create or replace function public.decrement_votes(item_id_input bigint)
returns void as
$$

begin
update public.items set votes = greatest(votes - 1, 0) where id = item_id_input;
end;

$$
language plpgsql;
$$


==============

item_suggestions 테이블 필드 설명
이 테이블은 사용자가 제안한 항목을 관리하기 위한 것으로



CREATE TABLE item_suggestions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL, -- 제안된 항목의 이름
  description TEXT, -- 제안된 항목의 설명
  category_id UUID NOT NULL REFERENCES categories(id), -- 제안된 항목의 카테고리 ID, categories 테이블의 id를 참조하는 외래 키
  user_email TEXT NOT NULL, -- 제안한 사용자의 이메일
  user_name TEXT NOT NULL, -- 제안한 사용자의 이름
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected')), -- 제안 상태 (대기, 승인, 거부)
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(), -- 제안 생성 시간
  processed_at TIMESTAMP WITH TIME ZONE, -- 제안이 처리(승인 또는 거부)된 날짜와 시간
  processed_by TEXT, -- 제안을 처리한 관리자의 이메일 또는 식별자
  rejection_reason TEXT, -- 거부 사유
  item_id BIGINT REFERENCES items(id) -- 제안이 승인되어 실제 항목으로 등록된 경우, 해당 항목의 ID, items 테이블의 id를 참조하는 외래 키
); 